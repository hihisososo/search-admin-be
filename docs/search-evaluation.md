## 검색평가

#### 개요
- 검색 품질을 테스트해보기 위해 오프라인 평가를 구현 하였습니다
- Precision, Recall 평가하도록 구현하였고, LLM 을 통해 1차평가 + 2차 개인적으로 평가하였습니다
- Precision, Recall 로 평가하도록 한 이유는 아래와 같습니다
  - 유저 데이터가 없으므로, 유저 데이터 기반 평가가 불가합니다
  - NDCG 처럼 검색된 문서에 연관도 점수를 차등 부여하는 방식은, LLM 자동 평가시, 잘못 평가되는 경우가 많았습니다
- LLM 자동평가에는 GPT-5-nano 를 사용하였습니다
- LLM 평가 후, 잘못평가된 부분은 2차 검수하였습니다

#### 평가셋 생성
- 평가를 위해 쿼리 <-> 정답문서 세트가 필요합니다
- 동일한 쿼리에 대해 실제검색(형태소)/바이그램/벡터 방식으로 질의해서 가능한 많은 정답 후보군을 가져오도록 하여 실제 검색에서의 놓친 문서를 찾을 수 있도록 고려하였습니다
- 평가 리소스 부족으로, 총 검색 결과 500개 이하의 작은 쿼리만 수행하였습니다
- 쿼리는 각 카테고리별 2개(총100개) 선별하여 결과 건수에 적합한 쿼리를 선별하였습니다

- 프롬프트(평가)
  ```
  당신은 이커머스 검색 엔진의 검색 관련성 평가를 위한 엄격하고 결정론적인 판단자입니다.
  검색 쿼리에 대해 상품들의 관련성을 평가해주세요.

  # 검색 정보
  검색 정보는 다음과 같은 JSON 형식으로 제공됩니다:

  예시:
  {"query": "삼성전자 SSD"}
  - query: 사용자가 입력한 원본 검색어

  # 평가할 상품들
  상품 데이터는 다음과 같은 JSON 배열 형식으로 제공됩니다:

  예시:
  [
    {
      "productId": "P12345",
      "name": "삼성전자 980 PRO NVMe M.2 SSD 1TB",
      "category": "컴퓨터/저장장치",
      "specs": "읽기속도: 7000MB/s, 쓰기속도: 5000MB/s, 인터페이스: PCIe 4.0"
    }
  ]

  - productId: 상품 고유 ID
  - name: 상품명
  - category: 카테고리
  - specs: 상세스펙

  ## 평가 기준
  - **1점 (연관)**: 
    - 검색 쿼리의 모든 부분이 상품명/스펙/카테고리에 모두 부합
    
  - **0점 (비연관)**: 
    - 1점에 해당되지 않는 상품
    - 검색어와 무관한 상품
    - 검색 의도와 다른 상품

  # 응답 형식
  반드시 아래 형식의 JSON 배열을 출력하세요. 각 상품은 한 줄로 작성하세요:

  [
  {"productId":"P12345","score":1,"reason":"브랜드, 제품 타입, 용량이 모두 일치"},
  {"productId":"P67890","score":0,"reason":"검색어와 관련 없는 카테고리"}
  ]

  각 필드 설명:
  - productId: 평가한 상품 ID
  - score: 관련성 점수 (0 또는 1)
  - reason: 평가 이유 (간결하게 핵심만 작성)

  # 주의사항
  - 모든 상품을 빠짐없이 평가 (입력된 모든 productId가 응답에 포함되어야 함)
  - 각 상품 객체는 한 줄로 압축, 상품 간에는 개행
  - 마크다운 사용 금지, 오직 JSON 배열만 출력


  검색 정보 데이터:
  {SEARCH_INFO}
  ----------------------------------------------------------
  상품 데이터:
  {PRODUCT_LIST}
  ```

#### 키워드 검색 평가 결과
- LLM 자동평가 기반 : precision 0.97, recall 300
- 사람 검수 후 : 
#### hybrid 검색 평가 결과
- LLM 자동평가 기반 : 

#### 긍정적 효과
- 아래와 같이 실검색에서 놓친 문서와, 동의어 등록 후보군들을 확인할 수 있었습니다
  - 놓친 문서 예시
  - 동의어 등록 후보

#### 한계점
- 평가 일관성이 부족하며, 잘못된 평가를 내리는 부분도 상당수 존재하였습니다
  - 일관성 부족
  - 잘못된 평가(브랜드가 없음에도 연관되었다고 평가)

#### 결론
- LLM 모델성능에 따라 다를수도 있겠지만, LLM 만으로는 평가가 부족해 보입니다
- 에러를 일부 감안하고, precision, recall 이 작은 부분을 체크한다면 유의미한 동의어나 형태소 분석이 잘못된 케이스를 확인할 수 있어 보입니다. 


#### 참고 문서
  - https://www.elastic.co/search-labs/blog/evaluating-search-relevance-part-2
  - https://www.dei.unipd.it/~ferro/papers/2024/IR-Book2024-FM.pdf