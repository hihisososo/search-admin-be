# 유의어 추천(형태소 term 기반, 독립 선택형) 스펙

본 문서는 유의어 확장을 "유의어 확장 후보 단어(= 형태소 term)" 단위로 독립적으로 수행하는 방식을 정리한다.

## 목표
- 상품명 코퍼스에서 추출한 단일 토큰(term)에 대해, 해당 term과 "완전히 동일 의미"인 단일 토큰 동의어만 소수(최대 2~3개) 추천한다.
- LLM은 "생성"이 아니라 "선택"에 가깝게 동작하도록 제약한다.

## 파이프라인
1) term 추출
   - ES 스크롤 → `nori_index_analyzer`로 토큰화
   - 정규화: trim/소문자
   - 필터: 길이≥2, 공백 없음, 숫자·기호만 토큰 제외, 간단 스톱리스트 제외
   - 빈도 상위 K개(term)를 유의어 확장 후보 단어로 선정

2) LLM 호출 (배치/독립 판단)
   - 한 호출에 후보 단어 10~20개씩만 전달
   - 프롬프트는 각 단어를 서로 "독립적으로" 판단하도록 명시
   - temperature=0, 응답 타임아웃 설정

3) 출력 형식(JSON only)
   - 단어별 객체 배열
   - 예시:
     ```json
     [
       { "term": "지포스", "synonyms": [ { "term": "geforce", "reason": "표기 차이" } ] },
       { "term": "라데온", "synonyms": [ { "term": "radeon", "reason": "표기 차이" } ] }
     ]
     ```

4) 서버 후처리(필수 최소)
   - 그룹 필터: 공백 포함/동일 토큰 반복/서로 다른 토큰 2개 미만 ⇒ 제외
   - 단어별 저장 상한: 최대 3개
   - 정규화(소문자/trim/기호·공백 제거)로 중복 제안 제거
   - 실패/타임아웃은 재시도 큐(최대 2~3회)

## 프롬프트 요지
- 파일: `src/main/resources/prompts/synonym-recommendation-by-term.txt`
- 핵심 제약:
  - 공백 없는 단일 토큰만
  - "완전히 동일 의미"(언어/철자/표기/약어 차이 등)만 허용
  - 후보 단어당 최대 3개, 불확실하면 빈 배열([])
  - 각 후보 단어를 서로 독립적으로 판단
  - JSON 배열만 출력

## 성능/운영
- 배치 크기 10~20, 동시성 4~8 권장(레이트리밋/지연 대비)
- 일별 처리량 한도 설정(예: 2k~5k 단어/일)
- 응답 샘플링 로그 기반으로 스톱리스트/상한 미세 조정

## 분석기 고려사항
- Nori의 합성어 분해 설정에 따라 "삼성전자"가 분해될 수 있음(decompound_mode)
  - discard: ["삼성","전자"], mixed: ["삼성전자","삼성","전자"], none: ["삼성전자"]
- 인덱스 토큰화 결과에 따라 특정 확장의 실효가 달라질 수 있음


